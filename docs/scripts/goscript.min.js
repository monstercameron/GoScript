class VirtualFileSystem{constructor(){this.files=new Map,this.directories=new Set,this.workingDirectory="/"}writeFile(e,t){const i=this.normalizePath(e);this.files.set(i,t),this.ensureDirectoryExists(this.getDirectory(i)),console.log(`ðŸ“ VFS: Written ${i} (${t.length} bytes)`)}readFile(e){const t=this.normalizePath(e);if(!this.files.has(t))throw new Error(`File not found: ${t}`);return this.files.get(t)}exists(e){const t=this.normalizePath(e);return this.files.has(t)}listDir(e="/"){let t=this.normalizePath(e);t.endsWith("/")||(t+="/");const i=new Set;for(const e of this.files.keys())if(e.startsWith(t)){const o=e.substring(t.length).split("/").filter(e=>e);o.length>0&&i.add(o[0])}for(const e of this.directories){let o=e;if(o.startsWith("/")||(o="/"+o),(o.startsWith(t)||"/"===t&&o.startsWith("/"))&&o.startsWith(t)){const e=o.substring(t.length).split("/").filter(e=>e);e.length>0&&i.add(e[0])}}return[...i].sort()}mkdir(e){const t=this.normalizePath(e);this.directories.add(t),console.log(`ðŸ“ VFS: Created directory ${t}`)}isDirectory(e){const t=this.normalizePath(e);return this.directories.has(t)}readDir(e){return this.listDir(e)}loadGoSources(e){console.log("ðŸ“¦ VFS: Loading Go source files...");for(const[t,i]of Object.entries(e))this.writeFile(t,i);this.mkdir("/src"),this.mkdir("/pkg"),this.mkdir("/bin"),console.log(`âœ… VFS: Loaded ${Object.keys(e).length} source files`)}getGoFiles(){return Array.from(this.files.keys()).filter(e=>e.endsWith(".go"))}getMainPackageFiles(){const e=[];for(const t of this.getGoFiles()){this.readFile(t).includes("package main")&&e.push(t)}return e}getModuleInfo(){try{const e=this.readFile("/go.mod"),t=e.match(/module\s+([^\s\n]+)/),i=e.match(/go\s+([0-9.]+)/);return{name:t?t[1]:"unknown",goVersion:i?i[1]:"1.21",dependencies:this.parseDependencies(e)}}catch(e){return{name:"personal-website-2025",goVersion:"1.21",dependencies:[]}}}parseDependencies(e){const t=[],i=e.match(/require\s*\(([\s\S]*?)\)/);if(i){const e=i[1].matchAll(/([^\s]+)\s+([^\s\n]+)/g);for(const i of e)t.push({name:i[1],version:i[2]})}return t}getFileTree(){const e=Array.from(this.files.keys()).sort();let t="Virtual Filesystem:\n";for(const i of e){const e=(i.match(/\//g)||[]).length-1;t+=`${"  ".repeat(e)}â”œâ”€â”€ ${i.split("/").pop()}\n`}return t}normalizePath(e){return e.startsWith("/")||(e="/"+e),e.replace(/\/+/g,"/")}getDirectory(e){const t=e.split("/");return t.pop(),t.join("/")||"/"}ensureDirectoryExists(e){"/"!==e&&this.directories.add(e)}clear(){this.files.clear(),this.directories.clear(),console.log("ðŸ—‘ï¸ VFS: Cleared all files")}getStats(){return{totalFiles:this.files.size,totalDirectories:this.directories.size,goFiles:this.getGoFiles().length,totalSize:Array.from(this.files.values()).reduce((e,t)=>e+t.length,0)}}}window.VirtualFileSystem=VirtualFileSystem;class FSPolyfill{constructor(e){this.vfs=e,this.fds=new Map,this.nextFd=100}patch(){const e=this;globalThis.fs={constants:{O_WRONLY:1,O_RDWR:2,O_CREAT:64,O_TRUNC:512,O_APPEND:1024,O_EXCL:128,O_DIRECTORY:65536},writeSync(t,i){if(1===t||2===t){const e=(new TextDecoder).decode(i);return window.addConsoleOutput?window.addConsoleOutput(e.trimEnd()):console.log(e),i.length}const o=e.fds.get(t);if(!o)throw new Error("EBADF");const n=new Uint8Array(o.content.length+i.length);return n.set(o.content),n.set(i,o.content.length),o.content=n,e.vfs.writeFile(o.path,o.content),i.length},write(t,i,o,n,s,a){try{if(1===t||2===t){const e=(new TextDecoder).decode(i.subarray(o,o+n));return window.addConsoleOutput?window.addConsoleOutput(e.trimEnd()):console.log(e),void a(null,n)}const r=e.fds.get(t);if(!r)return void a(new Error("EBADF"));const l=i.subarray(o,o+n);let c=null!==s?s:r.position;if(c+n>r.content.length){const e=new Uint8Array(c+n);e.set(r.content),r.content=e}r.content.set(l,c),null===s&&(r.position=c+n),e.vfs.writeFile(r.path,r.content),a(null,n)}catch(e){a(e)}},open(t,i,o,n){try{t.startsWith("/")||(t=e.vfs.workingDirectory+(e.vfs.workingDirectory.endsWith("/")?"":"/")+t),t=e.vfs.normalizePath(t);let o=new Uint8Array(0);if(e.vfs.exists(t)){const i=e.vfs.readFile(t);o="string"==typeof i?(new TextEncoder).encode(i):i}else if(!(64&i)){const e=new Error("ENOENT");return e.code="ENOENT",void n(e)}512&i&&(o=new Uint8Array(0));const s=e.nextFd++;e.fds.set(s,{path:t,flags:i,content:o,position:0}),n(null,s)}catch(e){n(e)}},read(t,i,o,n,s,a){try{const r=e.fds.get(t);if(!r)return void a(new Error("EBADF"));let l=null!==s?s:r.position;if(l>=r.content.length)return void a(null,0);const c=Math.min(l+n,r.content.length),d=c-l;i.set(r.content.subarray(l,c),o),null===s&&(r.position+=d),a(null,d)}catch(e){a(e)}},close(t,i){e.fds.get(t)&&e.fds.delete(t),i(null)},fstat(t,i){const o=e.fds.get(t);o?i(null,{isDirectory:()=>!1,isFile:()=>!0,size:o.content.length,mode:438,dev:0,ino:0,nlink:1,uid:0,gid:0,rdev:0,blksize:4096,blocks:0,atimeMs:Date.now(),mtimeMs:Date.now(),ctimeMs:Date.now()}):i(new Error("EBADF"))},stat(t,i){try{if(t.startsWith("/")||(t=e.vfs.workingDirectory+(e.vfs.workingDirectory.endsWith("/")?"":"/")+t),t=e.vfs.normalizePath(t),e.vfs.exists(t)){const o=e.vfs.readFile(t);i(null,{isDirectory:()=>!1,isFile:()=>!0,size:o.length,mode:438,dev:0,ino:0,nlink:1,uid:0,gid:0,rdev:0,blksize:4096,blocks:0,atimeMs:Date.now(),mtimeMs:Date.now(),ctimeMs:Date.now()})}else if(e.vfs.directories.has(t)||"/"===t)i(null,{isDirectory:()=>!0,isFile:()=>!1,size:0,mode:16895,dev:0,ino:0,nlink:1,uid:0,gid:0,rdev:0,blksize:4096,blocks:0,atimeMs:Date.now(),mtimeMs:Date.now(),ctimeMs:Date.now()});else{const e=new Error("ENOENT");e.code="ENOENT",i(e)}}catch(e){i(e)}},lstat(e,t){this.stat(e,t)},mkdir(t,i,o){try{e.vfs.mkdir(t),o(null)}catch(e){o(e)}},readdir(t,i){try{i(null,e.vfs.listDir(t))}catch(e){i(e)}},unlink(e,t){t(null)},rename(e,t,i){i(null)},rmdir(e,t){t(null)}},globalThis.process||(globalThis.process={}),globalThis.process.cwd=()=>e.vfs.workingDirectory,globalThis.process.chdir=t=>{e.vfs.workingDirectory=t}}}window.FSPolyfill=FSPolyfill;class CacheManager{constructor(){this.dbName="PersonalWebsite2025Cache",this.dbVersion=1,this.db=null,this.ready=!1}async init(){return new Promise((e,t)=>{console.log("ðŸ—„ï¸ CacheManager: Initializing IndexedDB cache...");const i=indexedDB.open(this.dbName,this.dbVersion);i.onerror=()=>{console.error("âŒ CacheManager: Failed to open IndexedDB"),t(new Error("Failed to initialize cache database"))},i.onsuccess=t=>{this.db=t.target.result,this.ready=!0,console.log("âœ… CacheManager: Cache database ready"),e()},i.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("sourceFiles")){t.createObjectStore("sourceFiles",{keyPath:"key"}).createIndex("timestamp","timestamp",{unique:!1})}if(!t.objectStoreNames.contains("compiledWasm")){t.createObjectStore("compiledWasm",{keyPath:"key"}).createIndex("timestamp","timestamp",{unique:!1})}t.objectStoreNames.contains("metadata")||t.createObjectStore("metadata",{keyPath:"key"}),console.log("ðŸ“Š CacheManager: Created object stores")}})}async cacheSourceFiles(e,t){this.ready||await this.init(),console.log(`ðŸ’¾ CacheManager: Caching source files for commit ${e}`);const i=this.db.transaction(["sourceFiles"],"readwrite").objectStore("sourceFiles"),o={key:`sources_${e}`,commitHash:e,files:t,timestamp:Date.now(),size:JSON.stringify(t).length};return new Promise((e,n)=>{const s=i.put(o);s.onsuccess=()=>{console.log(`âœ… CacheManager: Cached ${Object.keys(t).length} source files`),e()},s.onerror=()=>{console.error("âŒ CacheManager: Failed to cache source files"),n(new Error("Failed to cache source files"))}})}async getCachedSourceFiles(e){this.ready||await this.init();const t=this.db.transaction(["sourceFiles"],"readonly").objectStore("sourceFiles");return new Promise((i,o)=>{const n=t.get(`sources_${e}`);n.onsuccess=t=>{const o=t.target.result;o?(console.log(`ðŸŽ¯ CacheManager: Found cached sources for commit ${e}`),i(o.files)):(console.log(`ðŸ” CacheManager: No cached sources for commit ${e}`),i(null))},n.onerror=()=>{console.error("âŒ CacheManager: Failed to retrieve cached sources"),o(new Error("Failed to retrieve cached sources"))}})}async cacheCompiledWasm(e,t,i={}){this.ready||await this.init(),console.log(`ðŸ’¾ CacheManager: Caching WASM binary (${t.byteLength} bytes)`);const o=this.db.transaction(["compiledWasm"],"readwrite").objectStore("compiledWasm"),n={key:`wasm_${e}`,sourceHash:e,wasmBinary:t,metadata:i,timestamp:Date.now(),size:t.byteLength};return new Promise((e,t)=>{const i=o.put(n);i.onsuccess=()=>{console.log("âœ… CacheManager: Cached WASM binary"),e()},i.onerror=()=>{console.error("âŒ CacheManager: Failed to cache WASM binary"),t(new Error("Failed to cache WASM binary"))}})}async getCachedWasm(e){this.ready||await this.init();const t=this.db.transaction(["compiledWasm"],"readonly").objectStore("compiledWasm");return new Promise((i,o)=>{const n=t.get(`wasm_${e}`);n.onsuccess=t=>{const o=t.target.result;o?(console.log(`ðŸŽ¯ CacheManager: Found cached WASM for hash ${e}`),i({wasmBinary:o.wasmBinary,metadata:o.metadata,timestamp:o.timestamp})):(console.log(`ðŸ” CacheManager: No cached WASM for hash ${e}`),i(null))},n.onerror=()=>{console.error("âŒ CacheManager: Failed to retrieve cached WASM"),o(new Error("Failed to retrieve cached WASM"))}})}generateSourceHash(e){const t=JSON.stringify(e,Object.keys(e).sort());return this.simpleHash(t)}simpleHash(e){let t=0;for(let i=0;i<e.length;i++){t=(t<<5)-t+e.charCodeAt(i),t&=t}return Math.abs(t).toString(36)}async clearOldEntries(e=6048e5){this.ready||await this.init(),console.log("ðŸ§¹ CacheManager: Clearing old cache entries...");const t=Date.now()-e,i=["sourceFiles","compiledWasm"];for(const e of i){this.db.transaction([e],"readwrite").objectStore("sourceFiles").index("timestamp").openCursor(IDBKeyRange.upperBound(t)).onsuccess=e=>{const t=e.target.result;t&&(t.delete(),t.continue())}}console.log("âœ… CacheManager: Old entries cleared")}async getStats(){this.ready||await this.init();const e={sourceFiles:0,compiledWasm:0,totalSize:0},t=this.db.transaction(["sourceFiles","compiledWasm"],"readonly");t.objectStore("sourceFiles").count().onsuccess=t=>{e.sourceFiles=t.target.result};return t.objectStore("compiledWasm").count().onsuccess=t=>{e.compiledWasm=t.target.result},e}async clearAll(){this.ready||await this.init(),console.log("ðŸ—‘ï¸ CacheManager: Clearing all cache data...");const e=this.db.transaction(["sourceFiles","compiledWasm","metadata"],"readwrite"),t=[new Promise(t=>{e.objectStore("sourceFiles").clear().onsuccess=()=>t()}),new Promise(t=>{e.objectStore("compiledWasm").clear().onsuccess=()=>t()}),new Promise(t=>{e.objectStore("metadata").clear().onsuccess=()=>t()})];await Promise.all(t),console.log("âœ… CacheManager: All cache data cleared")}}window.CacheManager=CacheManager;class ToolchainLoader{constructor(){this.packData=null,this.compilerWasm=null,this.linkerWasm=null,this.packageIndex=new Map,this.packageNames=[],this.loaded=!1,this.packageDataStart=0,this.dbName="GoScriptCache",this.storeName="toolchain",this.cacheVersion=1}async openDB(){return new Promise((e,t)=>{const i=indexedDB.open(this.dbName,this.cacheVersion);i.onerror=()=>t(i.error),i.onsuccess=()=>e(i.result),i.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName)}})}async getCached(e){try{const t=await this.openDB();return new Promise((i,o)=>{const n=t.transaction(this.storeName,"readonly").objectStore(this.storeName).get(e);n.onerror=()=>{t.close(),o(n.error)},n.onsuccess=()=>{t.close(),i(n.result||null)}})}catch(e){return console.warn("ðŸ“¦ ToolchainLoader: IndexedDB not available, skipping cache"),null}}async setCache(e,t){try{const i=await this.openDB();return new Promise((o,n)=>{const s=i.transaction(this.storeName,"readwrite").objectStore(this.storeName).put(t,e);s.onerror=()=>{i.close(),n(s.error)},s.onsuccess=()=>{i.close(),o()}})}catch(e){console.warn("ðŸ“¦ ToolchainLoader: Failed to cache pack:",e.message)}}async load(e="assets/goscript.pack"){console.log("ðŸ“¦ ToolchainLoader: Checking cache for GoScript toolchain...");const t=await this.getCached(e);if(t)console.log(`âœ… ToolchainLoader: Loaded from cache (${(t.byteLength/1024/1024).toFixed(2)} MB)`),this.packData=t;else{console.log("ðŸ“¦ ToolchainLoader: Downloading GoScript toolchain (single file)...");const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load goscript.pack: ${t.status}`);this.packData=await t.arrayBuffer(),console.log(`ðŸ“¦ ToolchainLoader: Downloaded ${(this.packData.byteLength/1024/1024).toFixed(2)} MB`),console.log("ðŸ’¾ ToolchainLoader: Caching toolchain for future use..."),await this.setCache(e,this.packData),console.log("âœ… ToolchainLoader: Toolchain cached successfully")}this.parseToolchain(),this.loaded=!0,console.log(`âœ… ToolchainLoader: Ready (compiler: ${(this.compilerWasm.byteLength/1024/1024).toFixed(1)} MB, linker: ${(this.linkerWasm.byteLength/1024/1024).toFixed(1)} MB, ${this.packageIndex.size} packages)`)}async clearCache(){try{const e=await this.openDB();return new Promise((t,i)=>{const o=e.transaction(this.storeName,"readwrite").objectStore(this.storeName).clear();o.onerror=()=>{e.close(),i(o.error)},o.onsuccess=()=>{e.close(),console.log("ðŸ—‘ï¸ ToolchainLoader: Cache cleared"),t()}})}catch(e){console.warn("ðŸ“¦ ToolchainLoader: Failed to clear cache:",e.message)}}parseToolchain(){const e=new DataView(this.packData);let t=0;if("GOSCRIPT"!==(new TextDecoder).decode(new Uint8Array(this.packData,0,8)))throw new Error("Invalid goscript.pack format: bad magic");t+=8;const i=e.getUint32(t,!0);if(2!==i)throw new Error(`Unsupported pack version: ${i}`);t+=4;const o=e.getUint32(t,!0);t+=4,this.compilerWasm=this.packData.slice(t,t+o),t+=o,console.log(`ðŸ“¦ ToolchainLoader: Compiler extracted (${(o/1024/1024).toFixed(2)} MB)`);const n=e.getUint32(t,!0);t+=4,this.linkerWasm=this.packData.slice(t,t+n),t+=n,console.log(`ðŸ“¦ ToolchainLoader: Linker extracted (${(n/1024/1024).toFixed(2)} MB)`);const s=e.getUint32(t,!0);t+=4;const a=new Uint8Array(this.packData,t,s),r=(new TextDecoder).decode(a);this.packageNames=JSON.parse(r),t+=s,console.log(`ðŸ“¦ ToolchainLoader: Package index loaded (${this.packageNames.length} packages)`);const l=e.getUint32(t,!0);t+=4;const c=Number(e.getBigUint64(t,!0));t+=8,this.packageDataStart=t;let d=c;for(let t=0;t<l;t++){const t=e.getUint16(d,!0);d+=2;const i=new Uint8Array(this.packData,d,t),o=(new TextDecoder).decode(i);d+=t;const n=Number(e.getBigUint64(d,!0));d+=8;const s=e.getUint32(d,!0);d+=4,this.packageIndex.set(o,{offset:this.packageDataStart+n,size:s})}}getCompilerWasm(){return this.compilerWasm}getLinkerWasm(){return this.linkerWasm}getPackage(e){const t=this.packageIndex.get(e);return t?new Uint8Array(this.packData,t.offset,t.size):null}hasPackage(e){return this.packageIndex.has(e)}getPackageNames(){return this.packageNames}loadAllPackagesIntoVFS(e){console.log("ðŸ“‚ ToolchainLoader: Extracting packages to virtual filesystem...");let t=0,i=0;for(const[o,n]of this.packageIndex){const s=new Uint8Array(this.packData,n.offset,n.size);e.writeFile(`/pkg/js_wasm/${o}.a`,s),t++,i+=n.size}console.log(`âœ… ToolchainLoader: Extracted ${t} packages (${(i/1024/1024).toFixed(1)} MB) to /pkg/js_wasm/`)}getStats(){let e=0;for(const t of this.packageIndex.values())e+=t.size;return{packSize:this.packData?.byteLength||0,compilerSize:this.compilerWasm?.byteLength||0,linkerSize:this.linkerWasm?.byteLength||0,packageCount:this.packageIndex.size,totalPackageSize:e}}}window.ToolchainLoader=ToolchainLoader;class GitHubFetcher{constructor(){this.baseUrl="https://api.github.com",this.cache=new Map}async fetchGoWebComponentsSources(){return console.log("ðŸ” GitHubFetcher: Fetching GoWebComponents sources..."),{"examples/blog_landing_page.go":this.getStubGoCode(),"go.mod":this.getStubGoMod(),"go.sum":this.getStubGoSum()}}async fetchFile(e,t,i="main"){throw console.log(`ðŸ“„ GitHubFetcher: Fetching ${e}/${t} from ${i}`),new Error("GitHubFetcher.fetchFile() - Not implemented yet")}async getRepoStructure(e,t=""){throw console.log(`ðŸ“ GitHubFetcher: Getting structure for ${e}/${t}`),new Error("GitHubFetcher.getRepoStructure() - Not implemented yet")}async validateRepo(e){return console.log(`âœ… GitHubFetcher: Validating repository ${e}`),!0}getStubGoCode(){return'package main\n\nimport (\n    "fmt"\n    "github.com/gofiber/fiber/v2"\n)\n\nfunc main() {\n    app := fiber.New()\n    \n    app.Get("/", func(c *fiber.Ctx) error {\n        return c.HTML(`\n            <h1>ðŸŽ‰ Personal Website 2025</h1>\n            <p>Compiled from Go to WASM in your browser!</p>\n            <p>This is a demonstration of real-time Go compilation.</p>\n        `)\n    })\n    \n    fmt.Println("ðŸš€ Website compiled and ready!")\n    app.Listen(":3000")\n}'}getStubGoMod(){return"module personal-website-2025\n\ngo 1.21\n\nrequire (\n    github.com/gofiber/fiber/v2 v2.52.0\n)"}getStubGoSum(){return"github.com/gofiber/fiber/v2 v2.52.0 h1:example\ngithub.com/gofiber/fiber/v2 v2.52.0/go.mod h1:example"}}window.GitHubFetcher=GitHubFetcher;class CompilationManager{constructor(){this.vfs=null,this.cacheManager=null,this.compilerLoaded=!1,this.status="idle",this.callbacks={onProgress:null,onStageUpdate:null,onError:null,onComplete:null}}init(e,t){this.vfs=e,this.cacheManager=t,console.log("âš¡ CompilationManager: Initialized with VFS and CacheManager")}setCallbacks(e){this.callbacks={...this.callbacks,...e}}async compile(e){try{this.status="compiling",this.emitProgress(0,"COMPILATION_START"),this.filesToCompile=e,this.emitStageUpdate(1,"active"),await this.loadCompiler(),this.emitStageUpdate(1,"complete"),this.emitProgress(15,"COMPILER_READY"),this.emitStageUpdate(2,"active");const t=this.cacheManager.generateSourceHash(e),i=await this.cacheManager.getCachedWasm(t);if(i)return console.log("ðŸŽ¯ CompilationManager: Using cached WASM binary"),this.emitStageUpdate(2,"complete"),this.emitProgress(100,"CACHED_BINARY_LOADED"),this.status="complete",this.emitComplete(i.wasmBinary,i.metadata),i.wasmBinary;this.emitStageUpdate(2,"complete"),this.emitProgress(25,"CACHE_CHECKED"),this.emitStageUpdate(3,"active"),this.vfs.loadGoSources(e),this.emitStageUpdate(3,"complete"),this.emitProgress(40,"SOURCES_LOADED"),this.emitStageUpdate(4,"active"),await this.setupBuildEnvironment(),this.emitStageUpdate(4,"complete"),this.emitProgress(55,"VFS_READY"),this.emitStageUpdate(5,"active");const o=await this.compileToWasm();this.emitStageUpdate(5,"complete"),this.emitProgress(80,"WASM_COMPILED"),this.emitStageUpdate(6,"active");const n=this.generateMetadata();return await this.cacheManager.cacheCompiledWasm(t,o,n),this.emitStageUpdate(6,"complete"),this.emitProgress(95,"BINARY_CACHED"),this.emitStageUpdate(7,"active"),await this.prepareBinary(o),this.emitStageUpdate(7,"complete"),this.emitProgress(100,"READY_FOR_EXECUTION"),this.status="complete",this.emitComplete(o,n),o}catch(e){throw this.status="error",this.emitError(e.message),e}}async loadCompiler(){console.log("ðŸ”§ CompilationManager: Loading GoScript toolchain...");try{if(window.ToolchainLoader){console.log("ðŸ“¦ Using packed goscript.pack (compiler + linker + stdlib in 1 file)"),this.toolchainLoader=new window.ToolchainLoader,await this.toolchainLoader.load("assets/goscript.pack"),this.compileWasmBytes=this.toolchainLoader.getCompilerWasm(),this.linkWasmBytes=this.toolchainLoader.getLinkerWasm(),this.setupCompilerFilesystem(),this.toolchainLoader.loadAllPackagesIntoVFS(this.vfs);const e=this.toolchainLoader.getStats();return console.log(`âœ… CompilationManager: Toolchain ready (${(e.packSize/1024/1024).toFixed(1)} MB total)`),void(this.compilerLoaded=!0)}console.log("âš ï¸ ToolchainLoader not available, loading files separately..."),await this.loadCompilerSeparately()}catch(e){console.error("âŒ CompilationManager: Failed to load packed toolchain:",e),await this.loadCompilerSeparately()}}async loadCompilerSeparately(){try{const e=await fetch("assets/bin/compile.wasm");if(!e.ok)throw new Error(`Failed to fetch compile.wasm: ${e.status}`);this.compileWasmBytes=await e.arrayBuffer();const t=await fetch("assets/bin/link.wasm");if(!t.ok)throw new Error(`Failed to fetch link.wasm: ${t.status}`);this.linkWasmBytes=await t.arrayBuffer(),console.log(`ðŸ“¦ CompilationManager: Loaded compiler (${(this.compileWasmBytes.byteLength/1024/1024).toFixed(2)} MB) and linker (${(this.linkWasmBytes.byteLength/1024/1024).toFixed(2)} MB)`),this.setupCompilerFilesystem(),await this.loadStdLib(),this.compilerLoaded=!0,console.log("âœ… CompilationManager: Go compiler WASM loaded and ready")}catch(e){console.error("âŒ CompilationManager: Failed to load Go compiler:",e),await this.delay(500),this.compilerLoaded=!0,console.log("âš ï¸ CompilationManager: Using fallback mock compiler")}}async loadStdLib(){console.log("ðŸ“š CompilationManager: Loading Go standard library...");try{if(window.StdLibLoader){console.log("ðŸ“¦ Using packed stdlib.pack (340 packages in 1 file)"),this.stdlibLoader=new window.StdLibLoader,await this.stdlibLoader.load("static/pkg/stdlib.pack"),this.stdlibLoader.loadAllIntoVFS(this.vfs);const e=this.stdlibLoader.getStats();return void console.log(`âœ… CompilationManager: Standard library ready (${e.packageCount} packages, ${(e.packSize/1024/1024).toFixed(1)} MB)`)}console.log("âš ï¸ Packed stdlib not available, loading 340 packages individually (slower)..."),await this.loadStdLibIndividual()}catch(e){console.error("âŒ CompilationManager: Failed to load packed stdlib:",e),await this.loadStdLibIndividual()}}async loadStdLibIndividual(){console.log("ðŸ“š CompilationManager: Loading standard library individually...");try{const e=await fetch("static/pkg/index.json");if(!e.ok)throw new Error("Failed to load package index");const t=await e.json();console.log(`ðŸ“š CompilationManager: Found ${t.length} packages in index`);const i=async e=>{try{const t=await fetch(`static/pkg/js_wasm/${e}.a`);if(!t.ok)return;const i=await t.arrayBuffer();this.vfs.writeFile(`/pkg/js_wasm/${e}.a`,new Uint8Array(i))}catch(t){console.warn(`Failed to load package ${e}:`,t)}},o=10;for(let e=0;e<t.length;e+=o){const n=t.slice(e,e+o);await Promise.all(n.map(i))}console.log("âœ… CompilationManager: Standard library loaded")}catch(e){console.error("âŒ CompilationManager: Failed to load standard library:",e),await this.loadMinimalStdLib()}}async loadMinimalStdLib(){}async setupBuildEnvironment(){console.log("ðŸ—ï¸ CompilationManager: Setting up build environment..."),this.vfs.mkdir("/tmp"),this.vfs.mkdir("/build"),this.vfs.mkdir("/output");const e=this.generateBuildConfig();this.vfs.writeFile("/build/config.json",JSON.stringify(e,null,2)),console.log("âœ… CompilationManager: Build environment ready")}async compileToWasm(){console.log("ðŸ”¥ CompilationManager: Compiling Go to WASM using real Go compiler...");const e=this.vfs.getModuleInfo(),t=this.vfs.getGoFiles();if(console.log(`ðŸ“¦ CompilationManager: Module: ${e.name}`),console.log(`ðŸ“ CompilationManager: Compiling ${t.length} Go files`),this.compileWasmBytes&&this.linkWasmBytes)try{const e=await this.runGoCompiler();return console.log(`âœ… CompilationManager: Real WASM compiled (${e.byteLength} bytes)`),e}catch(e){console.warn(`âš ï¸ CompilationManager: Real compiler failed, using fallback: ${e.message}`),console.error(e)}const i=Math.max(1e3,200*t.length);await this.delay(i);const o=this.generateMockWasm();return console.log(`âœ… CompilationManager: Mock WASM compiled (${o.byteLength} bytes)`),o}async prepareBinary(e){if(console.log("ðŸŽ¯ CompilationManager: Preparing binary for execution..."),!this.validateWasmBinary(e))throw new Error("Invalid WASM binary generated");this.vfs.writeFile("/output/main.wasm",e),console.log("âœ… CompilationManager: Binary prepared for execution")}generateBuildConfig(){const e=this.vfs.getModuleInfo();return{module:e.name,goVersion:e.goVersion,target:"wasm",os:"js",arch:"wasm",buildTime:(new Date).toISOString(),optimization:"size",debug:!1}}generateMetadata(){const e=this.vfs.getStats();return{compilationTime:Date.now(),sourceFiles:e.goFiles,totalSize:e.totalSize,optimizations:["deadcode","size"],target:"js/wasm",version:"1.0.0"}}generateMockWasm(){const e=new Uint8Array([0,97,115,109,1,0,0,0]),t=new Uint8Array(2048);for(let e=0;e<t.length;e++)t[e]=Math.floor(256*Math.random());const i=new Uint8Array(e.length+t.length);return i.set(e,0),i.set(t,e.length),i.buffer}validateWasmBinary(e){if(e.byteLength<8)return!1;const t=new Uint8Array(e);return 0===t[0]&&97===t[1]&&115===t[2]&&109===t[3]}setupCompilerFilesystem(){if(console.log("ðŸ—‚ï¸ CompilationManager: Setting up compiler filesystem interface..."),window.FSPolyfill){new window.FSPolyfill(this.vfs).patch(),console.log("âœ… CompilationManager: Filesystem interface patched")}else console.warn("âš ï¸ CompilationManager: FSPolyfill not found")}async runGoCompiler(){console.log("âš™ï¸ CompilationManager: Invoking real Go compiler...");if(0===Object.keys(this.filesToCompile||{}).length)throw new Error("No Go files specified for compilation");const e=[];for(const[t,i]of Object.entries(this.filesToCompile)){const o=`/tmp/${t}`;this.vfs.writeFile(o,i),e.push(o)}console.log(`ðŸ“ CompilationManager: Compiling ${e.length} file(s): ${e.join(", ")}`),console.log("ðŸ“¦ VFS Stats:",this.vfs.getStats()),console.log("ðŸ“¦ pkg/js_wasm contents:",this.vfs.listDir("/pkg/js_wasm").slice(0,10));let t=[];const i=window.addConsoleOutput;window.addConsoleOutput=e=>{t.push(e),console.log("[COMPILER]",e),i&&i(e)};try{console.log("âš™ï¸ CompilationManager: Running compile..."),console.log("âš™ï¸ Args:",["compile","-o","/tmp/main.o","-p","main","-I","/pkg/js_wasm",...e]);const i=new Go;i.argv=["compile","-o","/tmp/main.o","-p","main","-I","/pkg/js_wasm",...e],i.env={GOOS:"js",GOARCH:"wasm",GOROOT:"/"};const o=await WebAssembly.instantiate(this.compileWasmBytes,i.importObject),n=i.run(o.instance);await n,console.log("Compile exit code:",i.exitCode),t.length>0&&console.log("Compiler output:",t.join("\n"))}finally{window.addConsoleOutput=i}if(!this.vfs.exists("/tmp/main.o")){const e=t.length>0?t.join("\n"):"No output from compiler";throw new Error(`Compilation failed: main.o not created. Compiler output: ${e}`)}console.log("âš™ï¸ CompilationManager: Running link...");const o=new Go;o.argv=["link","-o","/tmp/main.wasm","-L","/pkg/js_wasm","/tmp/main.o"],o.env={GOOS:"js",GOARCH:"wasm",GOROOT:"/"};const n=await WebAssembly.instantiate(this.linkWasmBytes,o.importObject);if(await o.run(n.instance),!this.vfs.exists("/tmp/main.wasm"))throw new Error("Linking failed: main.wasm not created");return this.vfs.readFile("/tmp/main.wasm").buffer}delay(e){return new Promise(t=>setTimeout(t,e))}emitProgress(e,t){this.callbacks.onProgress&&this.callbacks.onProgress(e,t)}emitStageUpdate(e,t){this.callbacks.onStageUpdate&&this.callbacks.onStageUpdate(e,t)}emitError(e){this.callbacks.onError&&this.callbacks.onError(e)}emitComplete(e,t){this.callbacks.onComplete&&this.callbacks.onComplete(e,t)}getStatus(){return this.status}cancel(){"compiling"===this.status&&(this.status="cancelled",console.log("ðŸ›‘ CompilationManager: Compilation cancelled"))}}window.CompilationManager=CompilationManager;class AppRunner{constructor(){this.wasmInstance=null,this.wasmModule=null,this.isRunning=!1,this.mountPoint=null,this.go=null,this.outputCallback=null}configureOutput(e){this.outputCallback=e,this.setupFsPolyfill()}setupFsPolyfill(){window.fs||(window.fs={});const e=e=>{if(this.outputCallback){const t=new TextDecoder("utf-8").decode(e);this.outputCallback(t)}};window.fs.writeSync=(t,i)=>1===t||2===t?(e(i),i.length):i.length,window.fs.write=(t,i,o,n,s,a)=>{1===t||2===t?(e(i.subarray(o,o+n)),a(null,n)):(console.log("fs.write",t),a(null,0))},window.fs.open||(window.fs.open=(e,t,i,o)=>{o(null,0)})}async init(){console.log("ðŸš€ AppRunner: Initializing WASM execution environment..."),"undefined"!=typeof Go?(this.go=new Go,console.log("âœ… AppRunner: Go runtime initialized")):console.warn("âš ï¸ AppRunner: wasm_exec.js not loaded, using mock runtime")}async execute(e,t={},i="root"){try{if(console.log(`ðŸŽ¯ AppRunner: Executing WASM binary (${e.byteLength} bytes)`),this.mountPoint=document.getElementById(i),!this.mountPoint)throw new Error(`Mount point #${i} not found`);await this.loadWasmModule(e),this.setupDOMEnvironment(),await this.runWasmApplication(),this.isRunning=!0,console.log("âœ… AppRunner: Application running successfully")}catch(e){throw console.error("âŒ AppRunner: Execution failed:",e.message),this.showError(e.message),e}}async executeConsole(e,t=null){try{console.log(`ðŸŽ¯ AppRunner: Executing Console WASM binary (${e.byteLength} bytes)`);if(e.byteLength<1e4)return console.log("ðŸŽ­ AppRunner: Using mock execution (compiler not available)"),void await this.executeMockConsole(t);await this.loadWasmModule(e),await this.runWasmApplication(!0),this.isRunning=!0,console.log("âœ… AppRunner: Console application finished")}catch(e){throw console.error("âŒ AppRunner: Console execution failed:",e.message),e}}async executeMockConsole(e){if(!e)return void(this.outputCallback&&this.outputCallback("(Mock execution - no source code provided)\n"));const t=e.matchAll(/fmt\.Println\s*\(\s*"([^"]*)"\s*\)/g),i=(e.matchAll(/fmt\.Printf\s*\(\s*"([^"]*)"[^)]*\)/g),[]);for(const e of t)i.push(e[1]);if(e.includes("Hello, World!"))i.length=0,i.push("Hello, World!"),i.push("Welcome to GoScript - Go in your browser!");else if(e.includes("fibonacci")){i.length=0,i.push("Fibonacci Sequence:");for(let e=0;e<15;e++)i.push(`fib(${e}) = ${this.fib(e)}`)}else if(e.includes("FizzBuzz")){i.length=0,i.push("FizzBuzz from 1 to 30:"),i.push("");for(let e=1;e<=30;e++)e%15==0?i.push("FizzBuzz"):e%3==0?i.push("Fizz"):e%5==0?i.push("Buzz"):i.push(String(e))}else if(e.includes("isPrime")){i.length=0,i.push("Prime numbers from 1 to 100:"),i.push("");let e="",t=0;for(let o=2;o<=100;o++)this.isPrime(o)&&(e+=String(o).padStart(4)+" ",t++,t%10==0&&(i.push(e),e=""));e&&i.push(e),i.push(""),i.push(`Found ${t} prime numbers.`)}else e.includes("Person")&&e.includes("Greet")&&(i.length=0,i.push("Meet our team:"),i.push(""),i.push("Hi, I'm Alice, 30 years old from New York!"),i.push("Hi, I'm Bob, 25 years old from San Francisco!"),i.push("Hi, I'm Charlie, 35 years old from Seattle!"));for(const e of i)this.outputCallback&&this.outputCallback(e+"\n"),await this.delay(10)}fib(e){return e<=1?e:this.fib(e-1)+this.fib(e-2)}isPrime(e){if(e<2)return!1;for(let t=2;t*t<=e;t++)if(e%t===0)return!1;return!0}async loadWasmModule(e){if(console.log("ðŸ“¦ AppRunner: Loading WASM module..."),this.go)try{this.wasmModule=await WebAssembly.instantiate(e,this.go.importObject),this.wasmInstance=this.wasmModule.instance,console.log("âœ… AppRunner: WASM module loaded with Go runtime")}catch(t){console.warn("âš ï¸ AppRunner: Go runtime failed, falling back to mock"),await this.loadMockModule(e)}else await this.loadMockModule(e)}async loadMockModule(e){console.log("ðŸŽ­ AppRunner: Loading mock WASM module..."),await this.delay(500),this.wasmModule={instance:{exports:{main:()=>this.renderMockApplication(),_start:()=>this.renderMockApplication()}}},this.wasmInstance=this.wasmModule.instance,console.log("âœ… AppRunner: Mock WASM module loaded")}setupDOMEnvironment(){console.log("ðŸŒ AppRunner: Setting up DOM environment..."),this.mountPoint.innerHTML="",this.injectApplicationCSS(),window.fs||(window.fs={writeSync:()=>{},write:()=>{}}),console.log("âœ… AppRunner: DOM environment ready")}async runWasmApplication(e=!1){console.log("â–¶ï¸ AppRunner: Starting WASM application..."),this.go?await this.go.run(this.wasmInstance):this.wasmInstance.exports.main?this.wasmInstance.exports.main():this.wasmInstance.exports._start?this.wasmInstance.exports._start():e?console.warn("âš ï¸ AppRunner: Mock application skipped in console mode"):this.renderMockApplication()}renderMockApplication(){console.log("ðŸŽ­ AppRunner: Rendering mock application..."),this.mountPoint.innerHTML=`\n            <div class="mock-app">\n                <header class="app-header">\n                    <h1>ðŸŽ‰ Personal Website 2025</h1>\n                    <p>Compiled from Go to WASM â€¢ Running in Browser</p>\n                </header>\n                \n                <main class="app-content">\n                    <div class="welcome-section">\n                        <h2>âœ¨ Welcome to the Future of Web Development</h2>\n                        <p>This website was compiled from Go source code directly in your browser using WebAssembly!</p>\n                    </div>\n                    \n                    <div class="features-grid">\n                        <div class="feature-card">\n                            <h3>ðŸš€ Real-time Compilation</h3>\n                            <p>Go source code fetched from GitHub and compiled to WASM instantly</p>\n                        </div>\n                        \n                        <div class="feature-card">\n                            <h3>ðŸ’¾ Smart Caching</h3>\n                            <p>IndexedDB caching with commit-hash based invalidation</p>\n                        </div>\n                        \n                        <div class="feature-card">\n                            <h3>ðŸŒ No Server Required</h3>\n                            <p>Everything runs in your browser - no backend needed</p>\n                        </div>\n                        \n                        <div class="feature-card">\n                            <h3>âš¡ Lightning Fast</h3>\n                            <p>WebAssembly performance with Go's simplicity</p>\n                        </div>\n                    </div>\n                    \n                    <div class="demo-section">\n                        <h3>ðŸŽ¯ Interactive Demo</h3>\n                        <button onclick="window.appRunner.handleDemoClick()" class="demo-button">\n                            Click me! (Handled by Go WASM)\n                        </button>\n                        <div id="demo-output" class="demo-output"></div>\n                    </div>\n                    \n                    <div class="tech-stack">\n                        <h3>ðŸ› ï¸ Technology Stack</h3>\n                        <div class="tech-tags">\n                            <span class="tech-tag">Go 1.21</span>\n                            <span class="tech-tag">WebAssembly</span>\n                            <span class="tech-tag">Fiber Framework</span>\n                            <span class="tech-tag">IndexedDB</span>\n                            <span class="tech-tag">GitHub API</span>\n                            <span class="tech-tag">Virtual Filesystem</span>\n                        </div>\n                    </div>\n                </main>\n                \n                <footer class="app-footer">\n                    <p>ðŸ”§ Compiled ${(new Date).toLocaleString()}</p>\n                    <p>ðŸ’š Powered by Go WebAssembly</p>\n                </footer>\n            </div>\n        `,window.appRunner=this}handleDemoClick(){const e=document.getElementById("demo-output"),t=["Hello from Go WASM! ðŸ‘‹","This interaction was handled by compiled Go code! ðŸš€","WebAssembly + Go = Amazing performance! âš¡","Your browser is now running Go! ðŸŽ‰","Fiber framework responding from WASM! ðŸŒ"],i=t[Math.floor(Math.random()*t.length)];e.innerHTML=`<p>ðŸŽ¯ ${i}</p>`,console.log("ðŸŽ­ AppRunner: Demo interaction handled")}injectApplicationCSS(){const e=document.createElement("style");e.textContent="\n            .mock-app {\n                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n                background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 25%, #16213e 50%, #1a1a2e 75%, #0a0a0f 100%);\n                color: #f8fafc;\n                min-height: 100vh;\n                padding: 2rem;\n                animation: fadeIn 0.8s ease-in-out;\n            }\n            \n            .app-header {\n                text-align: center;\n                margin-bottom: 3rem;\n            }\n            \n            .app-header h1 {\n                font-size: 3rem;\n                font-weight: bold;\n                margin-bottom: 0.5rem;\n                background: linear-gradient(90deg, #4f46e5, #7c3aed, #06b6d4);\n                -webkit-background-clip: text;\n                -webkit-text-fill-color: transparent;\n                text-shadow: 0 0 20px rgba(79, 70, 229, 0.3);\n            }\n            \n            .app-header p {\n                font-size: 1.2rem;\n                color: #cbd5e1;\n            }\n            \n            .welcome-section {\n                text-align: center;\n                margin-bottom: 3rem;\n                padding: 2rem;\n                background: rgba(26, 26, 46, 0.7);\n                border-radius: 1rem;\n                border: 1px solid rgba(79, 70, 229, 0.2);\n            }\n            \n            .features-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n                gap: 1.5rem;\n                margin-bottom: 3rem;\n            }\n            \n            .feature-card {\n                background: rgba(26, 26, 46, 0.7);\n                padding: 1.5rem;\n                border-radius: 0.75rem;\n                border: 1px solid rgba(79, 70, 229, 0.2);\n                backdrop-filter: blur(10px);\n            }\n            \n            .feature-card h3 {\n                color: #10b981;\n                margin-bottom: 0.5rem;\n            }\n            \n            .demo-section {\n                text-align: center;\n                margin-bottom: 3rem;\n                padding: 2rem;\n                background: rgba(26, 26, 46, 0.7);\n                border-radius: 1rem;\n                border: 1px solid rgba(79, 70, 229, 0.2);\n            }\n            \n            .demo-button {\n                background: linear-gradient(90deg, #10b981, #06d6a0);\n                color: white;\n                border: none;\n                padding: 1rem 2rem;\n                border-radius: 0.5rem;\n                font-size: 1.1rem;\n                font-weight: 600;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);\n            }\n            \n            .demo-button:hover {\n                transform: translateY(-2px);\n                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);\n            }\n            \n            .demo-output {\n                margin-top: 1rem;\n                min-height: 2rem;\n                font-size: 1.1rem;\n                color: #10b981;\n            }\n            \n            .tech-stack {\n                text-align: center;\n                margin-bottom: 2rem;\n            }\n            \n            .tech-tags {\n                display: flex;\n                flex-wrap: wrap;\n                justify-content: center;\n                gap: 0.5rem;\n                margin-top: 1rem;\n            }\n            \n            .tech-tag {\n                background: rgba(79, 70, 229, 0.2);\n                color: #a5b4fc;\n                padding: 0.5rem 1rem;\n                border-radius: 1rem;\n                font-size: 0.9rem;\n                font-weight: 500;\n                border: 1px solid rgba(79, 70, 229, 0.3);\n            }\n            \n            .app-footer {\n                text-align: center;\n                padding-top: 2rem;\n                color: #64748b;\n                border-top: 1px solid rgba(79, 70, 229, 0.2);\n            }\n            \n            @keyframes fadeIn {\n                from { opacity: 0; transform: scale(1.05); }\n                to { opacity: 1; transform: scale(1); }\n            }\n        ",document.head.appendChild(e)}showError(e){this.mountPoint&&(this.mountPoint.innerHTML=`\n                <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #0a0a0f; color: #f8fafc; font-family: 'Inter', sans-serif;">\n                    <div style="text-align: center; padding: 2rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 1rem;">\n                        <h2 style="color: #ef4444; margin-bottom: 1rem;">âŒ Application Error</h2>\n                        <p style="color: #cbd5e1; margin-bottom: 1rem;">${e}</p>\n                        <button onclick="window.location.reload()" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">\n                            ðŸ”„ Reload Page\n                        </button>\n                    </div>\n                </div>\n            `)}stop(){this.isRunning&&(console.log("ðŸ›‘ AppRunner: Stopping application..."),this.isRunning=!1,this.mountPoint&&(this.mountPoint.innerHTML=""),console.log("âœ… AppRunner: Application stopped"))}getStatus(){return{isRunning:this.isRunning,hasWasmModule:!!this.wasmModule,hasGoRuntime:!!this.go,mountPoint:this.mountPoint?.id||null}}delay(e){return new Promise(t=>setTimeout(t,e))}}window.AppRunner=AppRunner;class GoScript{constructor(e={}){this.options={packUrl:e.packUrl||"assets/goscript.pack",debug:e.debug||!1,onProgress:e.onProgress||(()=>{}),onOutput:e.onOutput||(e=>console.log(e)),onError:e.onError||(e=>console.error(e))},this.initialized=!1,this.toolchainLoader=null,this.vfs=null,this.compilationManager=null,this.appRunner=null,this.lastWasmBinary=null,this.compileStartTime=0}async init(){if(!this.initialized)try{if(this.log("[GoScript] Initializing GoScript..."),this.options.onProgress(0,"Starting initialization..."),this.vfs=new VirtualFileSystem,this.options.onProgress(10,"Fetching toolchain pack..."),this.toolchainLoader=new ToolchainLoader,await this.toolchainLoader.load(this.options.packUrl),this.options.onProgress(50,"Toolchain loaded..."),this.compilationManager=new CompilationManager,this.cacheManager=new CacheManager,await this.cacheManager.init(),this.compilationManager.init(this.vfs,this.cacheManager),window.FSPolyfill){new FSPolyfill(this.vfs).patch()}this.toolchainLoader.loadAllPackagesIntoVFS(this.vfs),this.options.onProgress(80,"Standard library loaded..."),this.compilationManager.compileWasmBytes=this.toolchainLoader.getCompilerWasm(),this.compilationManager.linkWasmBytes=this.toolchainLoader.getLinkerWasm(),this.compilationManager.compilerLoaded=!0,this.appRunner=new AppRunner,this.appRunner.init(this.vfs),this.options.onProgress(100,"Ready"),this.initialized=!0,this.log("[GoScript] Initialization complete")}catch(e){throw this.log(`[GoScript] Initialization failed: ${e.message}`),e}}async compile(e){if(!this.initialized)throw new Error("GoScript not initialized. Call init() first.");this.log("[GoScript] Starting compilation..."),this.compileStartTime=performance.now();try{const t={"main.go":e},i=window.addConsoleOutput;window.addConsoleOutput=e=>{this.options.onOutput(e),i&&i(e)};const o=await this.compilationManager.compile(t);window.addConsoleOutput=i;const n=Math.round(performance.now()-this.compileStartTime);return this.lastWasmBinary=o,this.log(`[GoScript] Compilation complete in ${n}ms`),{wasm:o,compileTime:n,size:o.byteLength}}catch(e){throw this.log(`[GoScript] Compilation failed: ${e.message}`),e}}async run(){if(!this.lastWasmBinary)throw new Error("No compiled binary available. Call compile() first.");this.log("[GoScript] Running compiled program...");try{this.appRunner.configureOutput(e=>{this.options.onOutput(e)}),await this.appRunner.executeConsole(this.lastWasmBinary),this.log("[GoScript] Program execution complete")}catch(e){throw this.log(`[GoScript] Execution failed: ${e.message}`),e}}async compileAndRun(e){try{const t=await this.compile(e);return await this.run(),{success:!0,compileResult:{wasm:t.wasm,metadata:{compileTime:t.compileTime,wasmSize:t.size}}}}catch(e){return{success:!1,error:e.message}}}getWasmBinary(){return this.lastWasmBinary}getStats(){if(!this.toolchainLoader)return{initialized:!1};const e=this.toolchainLoader.getStats();return{initialized:this.initialized,packSize:e.packSize,compilerSize:e.compilerSize,linkerSize:e.linkerSize,packageCount:e.packageCount,totalPackageSize:e.totalPackageSize}}isReady(){return this.initialized}log(e){this.options.debug&&console.log(e)}}window.GoScript=GoScript;const EXAMPLE_PROGRAMS={"/examples/hello/main.go":'package main\n\nimport "fmt"\n\nfunc main() {\n    fmt.Println("Hello, World!")\n    fmt.Println("Welcome to GoScript - Go in your browser!")\n}',"/examples/fibonacci/main.go":'package main\n\nimport "fmt"\n\nfunc fibonacci(n int) int {\n    if n <= 1 {\n        return n\n    }\n    return fibonacci(n-1) + fibonacci(n-2)\n}\n\nfunc main() {\n    fmt.Println("Fibonacci Sequence:")\n    for i := 0; i < 15; i++ {\n        fmt.Printf("fib(%d) = %d\\n", i, fibonacci(i))\n    }\n}',"/examples/fizzbuzz/main.go":'package main\n\nimport "fmt"\n\nfunc main() {\n    fmt.Println("FizzBuzz from 1 to 30:")\n    fmt.Println()\n    \n    for i := 1; i <= 30; i++ {\n        switch {\n        case i%15 == 0:\n            fmt.Println("FizzBuzz")\n        case i%3 == 0:\n            fmt.Println("Fizz")\n        case i%5 == 0:\n            fmt.Println("Buzz")\n        default:\n            fmt.Println(i)\n        }\n    }\n}',"/examples/primes/main.go":'package main\n\nimport "fmt"\n\nfunc isPrime(n int) bool {\n    if n < 2 {\n        return false\n    }\n    for i := 2; i*i <= n; i++ {\n        if n%i == 0 {\n            return false\n        }\n    }\n    return true\n}\n\nfunc main() {\n    fmt.Println("Prime numbers from 1 to 100:")\n    fmt.Println()\n    \n    count := 0\n    for i := 1; i <= 100; i++ {\n        if isPrime(i) {\n            fmt.Printf("%4d ", i)\n            count++\n            if count%10 == 0 {\n                fmt.Println()\n            }\n        }\n    }\n    fmt.Printf("\\n\\nFound %d prime numbers.\\n", count)\n}',"/examples/structs/main.go":'package main\n\nimport "fmt"\n\ntype Person struct {\n    Name string\n    Age  int\n    City string\n}\n\nfunc (p Person) Greet() string {\n    return fmt.Sprintf("Hi, I\'m %s, %d years old from %s!", p.Name, p.Age, p.City)\n}\n\nfunc main() {\n    people := []Person{\n        {Name: "Alice", Age: 30, City: "New York"},\n        {Name: "Bob", Age: 25, City: "San Francisco"},\n        {Name: "Charlie", Age: 35, City: "Seattle"},\n    }\n    \n    fmt.Println("Meet our team:")\n    fmt.Println()\n    \n    for _, person := range people {\n        fmt.Println(person.Greet())\n    }\n}'};class PersonalWebsite2025{constructor(){this.modules={gitHubFetcher:null,vfs:null,cacheManager:null,compilationManager:null,appRunner:null},this.state={initialized:!1,compiling:!1,compiled:!1,running:!1,compiledWasmBinary:null,lastSourceCode:null},this.ui={updateProgress:null,updateProgressText:null,setStageStatus:null,addConsoleOutput:null,showReadyState:null,showError:null},this.openTabs=[],this.activeTab=null,this.currentDir="/",this.editor=null,this.tabModified=new Map,this.tabContent=new Map}async init(e){try{this.ui=e,this.ui.addConsoleOutput("ðŸš€ GoScript: System initialization started"),this.initEditor(),await this.initializeModules(),this.loadExamplePrograms(),this.openAllExampleTabs(),this.modules.appRunner.configureOutput(e=>{this.ui.addConsoleOutput(e,!0)}),this.wireModules(),this.setupTerminal(),this.setupEditorButtons(),this.state.initialized=!0,this.ui.addConsoleOutput(""),this.ui.addConsoleOutput("âœ… GoScript: System ready!"),this.ui.addConsoleOutput(""),this.ui.addConsoleOutput("ðŸ“ Example programs available in /examples:"),this.ui.addConsoleOutput("   â€¢ /examples/hello      - Hello World"),this.ui.addConsoleOutput("   â€¢ /examples/fibonacci  - Fibonacci sequence"),this.ui.addConsoleOutput("   â€¢ /examples/fizzbuzz   - FizzBuzz challenge"),this.ui.addConsoleOutput("   â€¢ /examples/primes     - Prime numbers"),this.ui.addConsoleOutput("   â€¢ /examples/structs    - Go structs & methods"),this.ui.addConsoleOutput(""),this.ui.addConsoleOutput("ðŸ’¡ Try: cd /examples/hello && cat main.go && go run main.go")}catch(e){throw this.ui.addConsoleOutput(`âŒ GoScript: Initialization failed - ${e.message}`),this.ui.showError(e.message),e}}initEditor(){const e=document.getElementById("code-editor");this.editor=CodeMirror.fromTextArea(e,{mode:"go",theme:"dracula",lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,indentUnit:4,tabSize:4,indentWithTabs:!0,lineWrapping:!1,extraKeys:{"Ctrl-Z":()=>this.editor.undo(),"Ctrl-Y":()=>this.editor.redo(),"Ctrl-Shift-Z":()=>this.editor.redo(),"Ctrl-S":e=>(this.saveCurrentFile(),!1)}}),this.editor.on("change",()=>{this.activeTab&&(this.tabModified.set(this.activeTab,!0),this.renderTabs())}),this.editor.setValue("// Select a file from /examples to get started\n// Try: cd /examples/hello && cat main.go")}setupEditorButtons(){document.getElementById("undo-btn")?.addEventListener("click",()=>{this.editor.undo()}),document.getElementById("redo-btn")?.addEventListener("click",()=>{this.editor.redo()}),document.getElementById("save-btn")?.addEventListener("click",()=>{this.saveCurrentFile()})}saveCurrentFile(){if(!this.activeTab)return void this.ui.addConsoleOutput("No file open to save");const e=this.editor.getValue();this.modules.vfs.writeFile(this.activeTab,e),this.tabModified.set(this.activeTab,!1),this.tabContent.set(this.activeTab,e),this.renderTabs(),this.ui.addConsoleOutput(`ðŸ’¾ Saved: ${this.activeTab}`)}loadExamplePrograms(){const e=this.modules.vfs;e.mkdir("/examples"),e.mkdir("/examples/hello"),e.mkdir("/examples/fibonacci"),e.mkdir("/examples/fizzbuzz"),e.mkdir("/examples/primes"),e.mkdir("/examples/structs");for(const[t,i]of Object.entries(EXAMPLE_PROGRAMS))e.writeFile(t,i);this.ui.addConsoleOutput("ðŸ“¦ GoScript: Loaded 5 example programs")}openAllExampleTabs(){const e=["/examples/hello/main.go","/examples/fibonacci/main.go","/examples/fizzbuzz/main.go","/examples/primes/main.go","/examples/structs/main.go"],t=this.modules.vfs;for(const i of e)if(t.exists(i)){let e=t.readFile(i);e instanceof Uint8Array&&(e=(new TextDecoder).decode(e)),this.openTabs.push(i),this.tabContent.set(i,e),this.tabModified.set(i,!1)}this.openTabs.length>0&&(this.activeTab=this.openTabs[0],this.editor.setValue(this.tabContent.get(this.activeTab)),this.editor.clearHistory()),this.renderTabs()}handleTabCompletion(e){const t=e.value,i=e.selectionStart,o=t.substring(0,i),n=o.lastIndexOf(" ")+1,s=o.substring(n);if(!s)return;const a=this.modules.vfs;let r=[];if(s.includes("/")||s.startsWith(".")){let e,t;if(s.endsWith("/"))e=this.resolvePath(s),t="";else{const i=s.lastIndexOf("/");i>=0?(e=this.resolvePath(s.substring(0,i+1)),t=s.substring(i+1)):(e=this.currentDir,t=s)}const i=a.readDir(e);i&&(r=i.filter(e=>e.toLowerCase().startsWith(t.toLowerCase())).map(t=>{const i=e+(e.endsWith("/")?"":"/")+t,o=a.isDirectory(i);return s.substring(0,s.lastIndexOf("/")+1)+t+(o?"/":"")}))}else{r=["cd","ls","cat","pwd","clear","help","history","exit","go","tree","echo"].filter(e=>e.startsWith(s.toLowerCase()))}if(1===r.length){const o=t.substring(i);e.value=t.substring(0,n)+r[0]+o,e.selectionStart=e.selectionEnd=n+r[0].length}else if(r.length>1){this.ui.addConsoleOutput(r.join("  "));let o=r[0];for(const e of r)for(;!e.startsWith(o);)o=o.slice(0,-1);if(o.length>s.length){const s=t.substring(i);e.value=t.substring(0,n)+o+s,e.selectionStart=e.selectionEnd=n+o.length}}}resolvePath(e){if(e.startsWith("/"))return e;if("."===e)return this.currentDir;if(".."===e){const e=this.currentDir.split("/").filter(e=>e);return e.pop(),"/"+e.join("/")}if(e.startsWith("./")&&(e=e.substring(2)),e.startsWith("../")){const t=this.currentDir.split("/").filter(e=>e);return t.pop(),"/"+t.join("/")+"/"+e.substring(3)}return this.currentDir+(this.currentDir.endsWith("/")?"":"/")+e}async initializeModules(){this.ui.addConsoleOutput("ðŸ”§ GoScript: Creating module instances..."),this.modules.gitHubFetcher=new GitHubFetcher,this.modules.vfs=new VirtualFileSystem,this.modules.cacheManager=new CacheManager,this.modules.appRunner=new AppRunner,await this.modules.cacheManager.init(),await this.modules.appRunner.init(),this.modules.compilationManager=new CompilationManager,this.modules.compilationManager.init(this.modules.vfs,this.modules.cacheManager),this.ui.addConsoleOutput("âœ… GoScript: All modules created successfully")}wireModules(){this.ui.addConsoleOutput("ðŸ”— GoScript: Wiring module callbacks..."),this.modules.compilationManager.setCallbacks({onProgress:(e,t)=>{},onStageUpdate:(e,t)=>{const i=["","Compiler Load","Cache Check","Source Fetch","VFS Setup","Go Compile","Binary Cache","Prep Exec"];"active"===t&&this.ui.addConsoleOutput(`ðŸŽ¯ ${i[e]}...`)},onError:e=>{this.ui.addConsoleOutput(`âŒ COMPILATION_ERROR: ${e}`),this.state.compiling=!1,this.ui.showError(e)},onComplete:async(e,t)=>{this.state.compiledWasmBinary=e,this.state.compiled=!0,this.state.compiling=!1,this.ui.addConsoleOutput(`âœ… Compiled successfully (${e.byteLength} bytes)`),this.ui.addConsoleOutput(""),this.ui.addConsoleOutput("--- Program Output ---"),await this.runConsoleApp(),this.ui.addConsoleOutput("--- End Output ---"),this.ui.addConsoleOutput("")}}),this.ui.addConsoleOutput("âœ… GoScript: Module callbacks wired")}async startCompilation(e){if(this.state.compiling)this.ui.addConsoleOutput("âš ï¸ GoScript: Compilation already in progress");else try{this.state.compiling=!0,this.ui.addConsoleOutput(`ðŸ”„ GoScript: Compiling ${e}...`);const t=this.modules.vfs;if(!t.exists(e))throw new Error(`File not found: ${e}`);let i=t.readFile(e);i instanceof Uint8Array&&(i=(new TextDecoder).decode(i)),this.state.lastSourceCode=i;const o={"main.go":i};await this.modules.compilationManager.compile(o)}catch(e){throw this.state.compiling=!1,this.ui.addConsoleOutput(`âŒ GoScript: Compilation failed - ${e.message}`),e}}async startCompilationWithEditor(){if(this.state.compiling)this.ui.addConsoleOutput("âš ï¸ GoScript: Compilation already in progress");else try{if(this.state.compiling=!0,this.ui.addConsoleOutput("ðŸ”„ GoScript: Starting compilation pipeline..."),!this.activeTab)throw new Error("No file open. Use: cd /examples/hello && go run main.go");{const e=this.editor.getValue();this.state.lastSourceCode=e;const t={"main.go":e};await this.modules.compilationManager.compile(t)}}catch(e){throw this.state.compiling=!1,this.ui.addConsoleOutput(`âŒ GoScript: Compilation failed - ${e.message}`),e}}async launchApplication(){if(this.state.compiled&&this.state.compiledWasmBinary)try{this.state.running=!0,this.ui.addConsoleOutput("ðŸš€ GoScript: Launching compiled application..."),await this.modules.appRunner.execute(this.state.compiledWasmBinary),this.ui.addConsoleOutput("âœ… GoScript: Application launched successfully")}catch(e){throw this.state.running=!1,this.ui.addConsoleOutput(`âŒ GoScript: Launch failed - ${e.message}`),e}else this.ui.addConsoleOutput("âŒ GoScript: No compiled binary available for launch")}async runConsoleApp(){if(this.state.compiled&&this.state.compiledWasmBinary)try{await this.modules.appRunner.executeConsole(this.state.compiledWasmBinary,this.state.lastSourceCode)}catch(e){this.ui.addConsoleOutput(`âŒ GoScript: Execution failed - ${e.message}`)}else this.ui.addConsoleOutput("âŒ GoScript: No compiled binary available")}getStatus(){return{...this.state,modules:Object.keys(this.modules).reduce((e,t)=>(e[t]=!!this.modules[t],e),{}),appRunnerStatus:this.modules.appRunner?.getStatus()||null}}reset(){this.ui.addConsoleOutput("ðŸ”„ GoScript: Resetting system..."),this.modules.appRunner&&this.state.running&&this.modules.appRunner.stop(),this.state={initialized:!1,compiling:!1,compiled:!1,running:!1,compiledWasmBinary:null,lastSourceCode:null},this.modules.vfs&&this.modules.vfs.clear(),this.ui.addConsoleOutput("âœ… GoScript: System reset complete")}async getStats(){return{vfs:this.modules.vfs?.getStats()||null,cache:await(this.modules.cacheManager?.getStats())||null,compilation:{status:this.modules.compilationManager?.getStatus()||"unknown",hasBinary:!!this.state.compiledWasmBinary,binarySize:this.state.compiledWasmBinary?.byteLength||0}}}setupTerminal(){const e=document.getElementById("terminal-input"),t=document.getElementById("terminal-container");e&&t&&(this.commandHistory=[],this.historyIndex=-1,e.addEventListener("keydown",async i=>{if("Tab"===i.key)i.preventDefault(),this.handleTabCompletion(e);else if("Enter"===i.key){const i=e.value;e.value="",i.trim()&&(this.commandHistory.push(i),this.historyIndex=this.commandHistory.length),this.ui.addConsoleOutput(`$ ${i}`),await this.handleCommand(i.trim()),t.scrollTop=t.scrollHeight}else"ArrowUp"===i.key?(i.preventDefault(),this.historyIndex>0&&(this.historyIndex--,e.value=this.commandHistory[this.historyIndex])):"ArrowDown"===i.key&&(i.preventDefault(),this.historyIndex<this.commandHistory.length-1?(this.historyIndex++,e.value=this.commandHistory[this.historyIndex]):(this.historyIndex=this.commandHistory.length,e.value=""))}),t.addEventListener("click",()=>e.focus()),e.focus())}openFileInEditor(e){const t=this.modules.vfs;if(!t.exists(e))return void this.ui.addConsoleOutput(`cat: ${e}: No such file`);this.activeTab&&this.tabModified.get(this.activeTab)&&this.tabContent.set(this.activeTab,this.editor.getValue());let i=t.readFile(e);i instanceof Uint8Array&&(i=(new TextDecoder).decode(i)),this.openTabs.includes(e)||(this.openTabs.push(e),this.tabContent.set(e,i),this.tabModified.set(e,!1)),this.activeTab=e;const o=this.tabModified.get(e)?this.tabContent.get(e):i;this.editor.setValue(o),this.editor.clearHistory(),document.getElementById("current-file-path").textContent=e,this.renderTabs()}closeTab(e){const t=this.openTabs.indexOf(e);if(-1!==t){if(this.tabModified.get(e)&&this.ui.addConsoleOutput(`âš ï¸ Discarding unsaved changes in ${e}`),this.openTabs.splice(t,1),this.tabContent.delete(e),this.tabModified.delete(e),this.activeTab===e)if(this.openTabs.length>0){const e=this.openTabs[Math.max(0,t-1)];this.openFileInEditor(e)}else this.activeTab=null,this.editor.setValue("// No file open\n// Use: cd /examples/hello && cat main.go"),document.getElementById("current-file-path").textContent="No file open";this.renderTabs()}}renderTabs(){const e=document.getElementById("editor-tabs");if(e){e.innerHTML="";for(const t of this.openTabs){const i=document.createElement("div"),o=this.tabModified.get(t);i.className=`editor-tab font-mono ${t===this.activeTab?"active":""} ${o?"modified":""}`;const n=t.split("/").pop(),s=t.split("/").slice(-2,-1)[0]||"";i.innerHTML=`\n                <span class="tab-name">${s}/${n}</span>\n                <span class="tab-close" onclick="event.stopPropagation(); pws2025.closeTab('${t}')">Ã—</span>\n            `,i.onclick=()=>this.openFileInEditor(t),e.appendChild(i)}}}updatePrompt(){const e=document.getElementById("terminal-prompt");if(e){let t=this.currentDir;if(t.length>25){const e=t.split("/").filter(e=>e);t=".../"+e.slice(-2).join("/")}e.textContent=`${t} $`}}async handleCommand(e){if(!e)return;const t=e.match(/(?:[^\s"]+|"[^"]*")+/g)?.map(e=>e.replace(/"/g,""))||[],i=t[0],o=this.modules.vfs,n=e=>e?e.startsWith("/")?e:"/"===this.currentDir?"/"+e:this.currentDir+"/"+e:this.currentDir,s=e=>{const t=e.split("/").filter(e=>e&&"."!==e),i=[];for(const e of t)".."===e?i.pop():i.push(e);return"/"+i.join("/")};switch(i){case"help":this.ui.addConsoleOutput("Available commands:"),this.ui.addConsoleOutput("  Navigation: ls, cd, pwd"),this.ui.addConsoleOutput("  Files:      cat, head, tail, grep, touch, rm, cp, mv"),this.ui.addConsoleOutput("  Go:         go run <file>, go version"),this.ui.addConsoleOutput("  Other:      clear, echo, history, date, whoami, help"),this.ui.addConsoleOutput(""),this.ui.addConsoleOutput("Example: cd /examples/fibonacci && go run main.go");break;case"clear":document.getElementById("console-output").textContent="";break;case"date":this.ui.addConsoleOutput((new Date).toString());break;case"whoami":this.ui.addConsoleOutput("gopher");break;case"pwd":this.ui.addConsoleOutput(this.currentDir);break;case"echo":this.ui.addConsoleOutput(t.slice(1).join(" "));break;case"ls":const e=t[1]?s(n(t[1])):this.currentDir;try{const t=o.listDir(e);if(0===t.length)this.ui.addConsoleOutput("(empty directory)");else{t.map(t=>o.directories.has(s(e+"/"+t))?`[34m${t}/[0m`:t).join("  ");this.ui.addConsoleOutput(t.join("  "))}}catch(e){this.ui.addConsoleOutput(`ls: ${e.message}`)}break;case"cd":const a=t[1]||"/",r=s(n(a));"/"===r||o.directories.has(r)||o.listDir(r).length>0?(this.currentDir=r||"/",this.updatePrompt()):this.ui.addConsoleOutput(`cd: ${a}: No such directory`);break;case"mkdir":if(!t[1]){this.ui.addConsoleOutput("mkdir: missing operand");break}o.mkdir(s(n(t[1])));break;case"touch":if(!t[1]){this.ui.addConsoleOutput("touch: missing operand");break}o.writeFile(s(n(t[1])),"");break;case"rm":if(!t[1]){this.ui.addConsoleOutput("rm: missing operand");break}const l=s(n(t[1]));o.files.has(l)?o.files.delete(l):this.ui.addConsoleOutput(`rm: ${t[1]}: No such file`);break;case"cat":if(!t[1]){this.ui.addConsoleOutput("cat: missing operand");break}try{const e=s(n(t[1])),i=o.readFile(e),a=i instanceof Uint8Array?(new TextDecoder).decode(i):i;this.ui.addConsoleOutput(a),e.endsWith(".go")&&this.openFileInEditor(e)}catch(e){this.ui.addConsoleOutput(`cat: ${e.message}`)}break;case"cp":if(t.length<3){this.ui.addConsoleOutput("cp: missing file operand");break}try{const e=o.readFile(s(n(t[1])));o.writeFile(s(n(t[2])),e)}catch(e){this.ui.addConsoleOutput(`cp: ${e.message}`)}break;case"mv":if(t.length<3){this.ui.addConsoleOutput("mv: missing file operand");break}try{const e=s(n(t[1])),i=s(n(t[2])),a=o.readFile(e);o.writeFile(i,a),o.files.delete(e)}catch(e){this.ui.addConsoleOutput(`mv: ${e.message}`)}break;case"grep":if(t.length<3){this.ui.addConsoleOutput("grep: usage: grep PATTERN FILE");break}try{const e=t[1],i=o.readFile(s(n(t[2]))),a=i instanceof Uint8Array?(new TextDecoder).decode(i):i;a.split("\n").forEach(t=>{t.includes(e)&&this.ui.addConsoleOutput(t)})}catch(e){this.ui.addConsoleOutput(`grep: ${e.message}`)}break;case"head":if(!t[1]){this.ui.addConsoleOutput("head: missing operand");break}try{const e=o.readFile(s(n(t[1]))),i=(e instanceof Uint8Array?(new TextDecoder).decode(e):e).split("\n").slice(0,10);this.ui.addConsoleOutput(i.join("\n"))}catch(e){this.ui.addConsoleOutput(`head: ${e.message}`)}break;case"tail":if(!t[1]){this.ui.addConsoleOutput("tail: missing operand");break}try{const e=o.readFile(s(n(t[1]))),i=(e instanceof Uint8Array?(new TextDecoder).decode(e):e).split("\n");this.ui.addConsoleOutput(i.slice(-10).join("\n"))}catch(e){this.ui.addConsoleOutput(`tail: ${e.message}`)}break;case"history":this.commandHistory.forEach((e,t)=>{this.ui.addConsoleOutput(`${t+1}  ${e}`)});break;case"exit":this.ui.addConsoleOutput("logout");break;case"go":if("run"===t[1]){let e=t[2]||"main.go";const i=s(n(e));if(!o.exists(i)){this.ui.addConsoleOutput(`go run: ${e}: no such file`);break}this.openFileInEditor(i),await this.startCompilation(i)}else"version"===t[1]?this.ui.addConsoleOutput("go version go1.21.0 js/wasm"):(this.ui.addConsoleOutput("Usage: go run <file.go>"),this.ui.addConsoleOutput("       go version"));break;case"./main.wasm":this.state.compiled?await this.launchApplication():this.ui.addConsoleOutput("bash: ./main.wasm: No such file or directory (compile first)");break;case"tree":this.ui.addConsoleOutput(o.getFileTree());break;default:this.ui.addConsoleOutput(`bash: command not found: ${i}`)}}}window.PersonalWebsite2025=PersonalWebsite2025;